![세션 인증 과정](../img/세션인증과정.png)

세션은 서버의 인메모리(세션 스토어에 세션을 저장), 쿠키를 이용해서 구현하는 것이다.

1. post/login 요청
{id: kimcoding,
pw :secret }
2. 서버에서 인증정보 확인 (암호화를 해서 디비 정보와 맞는지 확인)
3. 세션 스토어에 세션을 생성(세션 아이디와 정보)
4. 성공 메세지와 함께 set-cookie: 세션 아이디 전달
5. 쿠키 저장소에 세션 아이디가 저장됨
5-1. get/mypage
cookie: 세션 아이디와 함께 같이 요청을 실어 보낸다.
6. 세션 스토어의 세션 아이디와 쿠키에 있는 아이디, 즉 세션이 유효한지 확인 한 후
7. 응답을 보낸다.


### 세션기반 인증 (Session-based Authentication)

#### 로그인
사용자가 로그인 시도를 할 때 정확한 아이디와 비밀번호를 입력했다면, 서버는 인증(Authentication)에 성공했다고 판단할 것이다. 그렇다면, 다음번에 인증을 필요로 하는 작업(장바구니에 물품 추가 등)을 요청할 경우, 또 로그인 과정을 거쳐야 할까? 서버는 아이디 및 비밀번호의 해시를 이미 알고 있기 때문에, "인증에 성공했음"을 서버가 알고 있다면, 매번 로그인할 필요가 없을 것이다.

이때 서버와 클라이언트에 각각 필요한 것이 있다.

1. 서버는 사용자가 인증에 성공했음을 알고 있어야 한다.
사용자가 인증에 성공한 상태는 세션이라고 부른다. 서버는 일종의 저장소에 세션을 저장한다. 주로 in-memory(자바스크립트 객체) 또는 세션 스토어(redis 등과 같은 트랜잭션이 빠른 DB)에 저장한다. 세션이 만들어지면, 각 세션을 구분할 수 있는 세션 아이디도 만들어지는데 보통 클라이언트에 세션 성공을 증명할 수단으로써 세션 아이디를 전달한다.

2. 클라이언트는 인증 성공을 증명할 수단을 갖고 있어야 한다.
이때 웹사이트에서 로그인을 유지하기 위한 수단으로 쿠키를 사용한다. 쿠키에는 서버에서 발급한 세션 아이디를 저장한다. 쿠키를 통해 유효한 세션 아이디가 서버에 전달되고, 세션 스토어에 해당 세션이 존재한다면 서버는 해당 요청에 접근 가능하다고 판단한다. 하지만 쿠키에 세션 아이디 정보가 없는 경우, 서버는 해당 요청이 인증되지 않았음을 알려준다.


#### 로그아웃
세션 아이디가 담긴 쿠키는 클라이언트에 저장되어 있으며, 서버는 세션을 저장하고 있다. 서버는 그저 세션 아이디로만 요청을 판단한다.

로그아웃은 다음 두 가지 작업을 해야 한다.

1. 서버의 세션 정보를 삭제해야 한다.
2. 클라이언트의 쿠키를 갱신해야 한다.

서버가 클라이언트의 쿠키를 임의로 삭제할 수는 없다. 대신, set-cookie로 세션 아이디의 키값을 무효한 값으로 갱신해야 한다.

#### express-session
이런 세션을 대신 관리해주는 'express-session' 이라는 모듈이 존재한다.

'express-session'은 세션을 위한 미들웨어로, 'Express'에서 세션을 다룰 수 있는 공간을 보다 쉽게 만들어준다. 또한 필요한 경우 세션 아이디를 쿠키에 저장하고, 해당 세션 아이디에 종속되는 고유한 세션 객체를 서버 메모리에 저장한다.

+ [express-req.session](https://github.com/expressjs/session#reqsession)이 바로 세션 객체이며 req.session은 세션 객체에 세션 데이터를 저장하거나 불러오기 위해 사용한다.
